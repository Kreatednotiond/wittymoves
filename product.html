// assets/js/product.js
(function () {
  // If a shop grid ever exists on this page, kill it (prevents “all products” view)
  const accidentalGrid = document.getElementById("shopGrid");
  if (accidentalGrid) {
    accidentalGrid.innerHTML = "";
    accidentalGrid.style.display = "none";
  }

  const params = new URLSearchParams(location.search);
  const id = params.get("id");

  const wrap = document.getElementById("productWrap");
  const notFound = document.getElementById("notFound");

  const nameEl = document.getElementById("pName");
  const priceEl = document.getElementById("pPrice");
  const descEl = document.getElementById("pDesc");

  const mainImage = document.getElementById("mainImage");
  const thumbs = document.getElementById("thumbs");

  const sizeChips = document.getElementById("sizeChips");
  const colorSwatches = document.getElementById("colorSwatches");

  const addBtn = document.getElementById("addBtn");

  const items = window.WITTY_PRODUCTS || [];
  const product = items.find((p) => p.id === id);

  if (!id || !product) {
    if (wrap) wrap.style.display = "none";
    if (notFound) notFound.style.display = "block";
    return;
  }

  const money = (n) => {
    const num = Number(n);
    return Number.isFinite(num) ? num.toFixed(2) : "0.00";
  };

  // --------- Basic info ----------
  document.title = `${product.name} | Witty Moves`;
  if (nameEl) nameEl.textContent = product.name;
  if (priceEl) priceEl.textContent = `$${money(product.price)}`;
  if (descEl) descEl.textContent = product.description || "";

  // --------- Main image ----------
  const setMain = (src) => {
    if (!mainImage) return;
    mainImage.src = src || "";
    mainImage.alt = product.name;
  };

  let selectedSize = (product.sizes && product.sizes[0]) ? product.sizes[0] : "";
  let selectedColor = (product.colors && product.colors[0]) ? product.colors[0] : null;

  // Default image = selected color image (or gallery[0] for jacket/hat)
  const defaultImg =
    (selectedColor && selectedColor.img) ||
    (product.gallery && product.gallery[0]) ||
    (product.colors && product.colors[0] && product.colors[0].img) ||
    "";

  setMain(defaultImg);

  // --------- THUMBS ----------
  // Show ONLY if gallery exists (hat/jackets). Do NOT show all colors as thumbs.
  if (thumbs) {
    thumbs.innerHTML = "";
    const gallery = (product.gallery && product.gallery.length) ? product.gallery : [];

    if (gallery.length > 1) {
      thumbs.style.display = ""; // show

      const activeSrc = defaultImg && gallery.includes(defaultImg) ? defaultImg : gallery[0];

      gallery.forEach((src, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "thumb" + (src === activeSrc ? " active" : "");
        btn.innerHTML = `<img src="${src}" alt="${product.name} thumbnail